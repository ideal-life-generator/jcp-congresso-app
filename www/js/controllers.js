// Generated by CoffeeScript 1.7.1
(function() {
  var atea;

  atea = angular.module('atea');

  atea.controller('RateController', [
    '$scope', '$location', 'baseURL', '$routeParams', 'connection', '$filter', '$compile', 'getData', '$http', 'loto', '$timeout', 'message', function($scope, $location, baseURL, $routeParams, connection, $filter, $compile, getData, $http, loto, $timeout, message) {
      connection.makeLoad({
        params: {
          resource: 'surveyQuestion',
          data: {
            survey_id: $routeParams.rateseId
          }
        },
        handler: function(data) {
          var tokes;
          $scope.fields = [];
          angular.forEach(data, function(field) {
            return $scope.fields.push(field);
          });
          $scope.fields = $filter('orderBy')($scope.fields, 'name');
          tokes = angular.element(document.querySelector("form[name='surveyForm'] ul"));
          return angular.forEach($scope.fields, function(field, i) {
            return tokes.append($compile("<survey-" + $scope.fields[i].type + " setting='fields[" + i + "]'></survey-" + $scope.fields[i].type + ">")($scope));
          });
        },
        scope: $scope,
        type: "noCache"
      });
      return $scope.submitSurveyQuestions = function() {
        var result;
        if ($scope.surveyForm.$valid) {
          message.open($scope.local.processing_data);
          result = [];
          angular.forEach($scope.fields, function(field, i) {
            var proto;
            proto = {};
            if (field.value) {
              if (field.type === "checkboxlist") {
                return angular.forEach(field.options, function(option) {
                  if (option.value) {
                    proto = {};
                    proto.answer_value = option.answer_value;
                    proto.survey_id = $routeParams.rateseId;
                    proto.question_id = field.id;
                    return result.push(proto);
                  }
                });
              } else {
                proto.answer_value = field.value;
                proto.survey_id = $routeParams.rateseId;
                proto.question_id = field.id;
                return result.push(proto);
              }
            }
          });
          if (result.length && $scope.surveyForm.$valid) {
            return getData.save({
              resource: 'surveyAnswer'
            }, {
              data: {
                records: result
              }
            }, function(result) {
              return message.open($scope.local.form_saved, function() {
                if ($scope.event.tokensActive) {
                  message.open($scope.local.form_token);
                  return getData.put({
                    resource: 'participant'
                  }, {
                    data: {
                      id: $scope.participient.id,
                      extraParam: {
                        addTokens: 'passageSurvey',
                        survey_id: $routeParams.rateseId
                      }
                    }
                  }, function(result) {
                    var data, tokens;
                    data = result.data;
                    if (data.success) {
                      tokens = data.message.receivedTokens;
                      return loto.run(tokens, function() {
                        return message.authoClose($scope.polyglot.t("tokens_add", ~~tokens), function() {
                          return void 0;
                        }, function() {
                          if ($scope.contentAnimate !== $scope.animationContentRight) {
                            $scope.contentAnimate = $scope.animationContentRight;
                          }
                          history.back();
                          return loto.number = null;
                        });
                      });
                    } else {
                      return message.authoClose($scope.local.error_server, function() {
                        if ($scope.contentAnimate !== $scope.animationContentRight) {
                          $scope.contentAnimate = $scope.animationContentRight;
                        }
                        history.back();
                        return loto.number = null;
                      });
                    }
                  });
                } else {
                  if ($scope.contentAnimate !== $scope.animationContentRight) {
                    $scope.contentAnimate = $scope.animationContentRight;
                  }
                  history.back();
                  return loto.number = null;
                }
              });
            }, function(error) {
              return message.noClose($scope.local.no_connection);
            });
          } else {
            return message.noClose($scope.local.form_error);
          }
        } else {
          return message.noClose($scope.local.form_error1);
        }
      };
    }
  ]);

  atea.controller('RatesController', [
    '$scope', '$location', 'baseURL', '$routeParams', 'connection', '$rootScope', '$timeout', 'message', function($scope, $location, baseURL, $routeParams, connection, $rootScope, $timeout, message) {
      return connection.makeLoad({
        params: {
          resource: 'survey',
          data: {
            event_id: $routeParams.feedId
          }
        },
        handler: function(data) {
          if (!data.success) {
            $scope.surveys = [];
            angular.forEach(data, function(survey) {
              return $scope.surveys.push(survey);
            });
            if (!$scope.surveys.length) {
              return message.authoClose($scope.local.no_surveys, function() {
                return history.back();
              });
            }
          } else {
            return message.authoClose($scope.local.no_surveys, function() {
              return history.back();
            });
          }
        },
        scope: $scope,
        type: "noCache"
      });
    }
  ]);

  atea.controller('ScheduleController', [
    '$scope', '$location', 'baseURL', '$routeParams', 'getData', '$http', '$rootScope', 'connection', function($scope, $location, baseURL, $routeParams, getData, $http, $rootScope, connection) {
      return connection.makeLoad({
        params: {
          resource: 'activity',
          id: $routeParams.scheduleId
        },
        handler: function(data) {
          $scope.schedule = data;
          if ($scope.schedule.survey_id !== "0") {
            return getData.noCache({
              resource: 'survey',
              id: $scope.schedule.survey_id
            }, function(result) {
              data = {};
              angular.forEach(result.data, function(ths) {
                return data = ths;
              });
              if (data.is_answered !== "0") {
                return $scope.schedule.is_visible = true;
              }
            });
          }
        },
        scope: $scope,
        type: "noCache"
      });
    }
  ]);

  atea.controller('SchedulesController', [
    '$scope', '$location', '$routeParams', 'getData', '$filter', '$http', '$rootScope', 'connection', 'message', function($scope, $location, $routeParams, getData, $filter, $http, $rootScope, connection, message) {
      var getSchedules;
      getSchedules = function(data) {
        var dayyy, oldData, ressuulltt, timeee;
        oldData = data;
        ressuulltt = [];
        data = [];
        dayyy = [];
        timeee = [];
        angular.forEach(oldData, function(ths) {
          return data.push(ths);
        });
        data = $filter('orderBy')(data, '+start_time');
        angular.forEach(data, function(ths, i, data) {
          var date, dateNext, day, dayNext, month, monthNext, n;
          date = new Date(ths.start_time * 1000);
          day = date.getDate();
          month = date.getMonth();
          if (data[i + 1]) {
            n = 1;
          } else {
            n = -1;
          }
          dateNext = new Date(data[i + n].start_time * 1000);
          dayNext = dateNext.getDate();
          monthNext = dateNext.getMonth();
          if (ths.start_time === data[i + n].start_time && i !== data.length - 1) {
            timeee.push(ths);
          } else {
            timeee.push(ths);
            dayyy.push(timeee);
            timeee = [];
          }
          if (!(day === dayNext && month === monthNext) || i === data.length - 1) {
            ressuulltt.push(dayyy);
            return dayyy = [];
          }
        });
        return $scope.schedules = ressuulltt;
      };
      return connection.makeLoad({
        params: {
          resource: "activity",
          data: "{'event_id': " + $routeParams.feedId + "}"
        },
        handler: getSchedules,
        scope: $scope,
        type: "noCache"
      });
    }
  ]);

  atea.controller('CommentController', [
    '$scope', '$location', 'baseURL', '$routeParams', '$rootScope', '$http', '$timeout', 'connection', 'message', function($scope, $location, baseURL, $routeParams, $rootScope, $http, $timeout, connection, message) {
      connection.makeLoad({
        params: {
          resource: 'leadType'
        },
        handler: function(data) {
          $scope.categories = [
            {
              id: null,
              name: $scope.local.select_category
            }
          ];
          return angular.forEach(data, function(ths) {
            return $scope.categories.push(ths);
          });
        },
        scope: $scope,
        type: "noCache"
      });
      $scope.categorieActive = $scope.local.select_category;
      $scope.interest = "5";
      $scope.revenue = "5";
      return $scope.submit = function() {
        var data;
        if ($scope.categorieActive !== $scope.categories[0].name) {
          $scope.noValid = false;
          data = {
            interrogatorId: userStatus.detail.eventId,
            categorie: $scope.categorieActive,
            interest: $scope.interest,
            revenue: $scope.revenue,
            comment: $scope.comments
          };
          message.open = $scope.local.data_sending;
          return getData.submitRecord(data).$promise.then(function() {
            return message.authoClose($scope.local.message_posted, function() {
              return $location.path(baseURL.FEEDS + $routeParams.feedId);
            });
          });
        } else {
          return $scope.noValid = true;
        }
      };
    }
  ]);

  atea.controller('PartnerController', [
    '$scope', '$location', 'baseURL', '$routeParams', '$rootScope', 'connection', 'getData', '$http', 'message', function($scope, $location, baseURL, $routeParams, $rootScope, connection, getData, $http, message) {
      connection.makeLoad({
        params: {
          resource: 'partnerCompany',
          id: $routeParams.partnerId
        },
        handler: function(data) {
          return $scope.partner = data;
        },
        scope: $scope,
        type: "noCache"
      });
      return $scope.submitQuestion = function() {
        if ($scope.questionToPartner) {
          message.open($scope.local.processing_data);
          return getData.save({
            resource: 'partnerMessage'
          }, {
            data: {
              event_id: $routeParams.feedId,
              message: $scope.questionToPartner
            }
          }, function(result) {
            message.authoClose($scope.local.quest_sent);
            return $scope.invalid = false;
          }, function(error) {
            return message.noClose($scope.local.no_connection);
          });
        } else if ($scope.partnerForm) {
          return message.odinAndClose($scope.local.quest_error);
        } else {
          message.odinAndClose($scope.local.fill_input);
          return $scope.invalid = true;
        }
      };
    }
  ]);

  atea.controller('PartnersController', [
    '$scope', '$location', 'baseURL', '$routeParams', '$rootScope', '$http', '$filter', 'getData', 'connection', function($scope, $location, baseURL, $routeParams, $rootScope, $http, $filter, getData, connection) {
      var getPartners;
      getPartners = function(data) {
        $scope.partners = [];
        return angular.forEach(data, function(partner) {
          return $scope.partners.push(partner);
        });
      };
      return connection.makeLoad({
        params: {
          resource: 'partnerCompany',
          data: "{'event_id': " + $routeParams.feedId + "}"
        },
        handler: getPartners,
        scope: $scope,
        type: "noCache"
      });
    }
  ]);

  atea.controller('GuestController', [
    '$scope', '$window', '$location', 'baseURL', '$routeParams', '$rootScope', 'client', 'getData', 'connection', 'loto', 'message', function($scope, $window, $location, baseURL, $routeParams, $rootScope, client, getData, connection, loto, message) {
      return $scope.scanActivator = function() {
        return cordova.plugins.barcodeScanner.scan(function(result) {
          message.open($scope.local.check_scan);
          return connection.makeLoad({
            params: {
              resource: 'member',
              data: "{ 'extraParam': { 'barcode': '" + result.text + "' }}"
            },
            handler: function(data) {
              if (data.success) {
                return message.noClose($scope.local.scan_error1);
              } else {
                $rootScope.member = data;
                $location.path($routeParams.feedId + baseURL.COMMENTPAGEHREF);
                return $scope.$apply();
              }
            },
            scope: $scope,
            type: "noCache"
          });
        }, function(error) {
          return message.noClose($scope.local.error_scaning);
        });
      };
    }
  ]);

  atea.controller('EventsController', [
    '$scope', '$filter', 'baseURL', '$location', '$rootScope', '$routeParams', 'connection', 'client', function($scope, $filter, baseURL, $location, $rootScope, $routeParams, connection, client) {
      $rootScope.event = null;
      return $rootScope.updateEvents();
    }
  ]);

  atea.controller('ProfileController', [
    '$scope', '$location', 'baseURL', '$routeParams', '$rootScope', 'connection', function($scope, $location, baseURL, $routeParams, $rootScope, connection) {
      return $scope.dyna.tokens_val = $scope.polyglot.t("tokens_val", ~~$scope.participient.tokens);
    }
  ]);

  atea.controller('MainController', [
    '$scope', '$location', 'baseURL', '$rootScope', '$routeParams', '$timeout', '$window', 'client', '$route', '$filter', 'getData', 'connection', 'loto', 'COMPANY_ID', 'local', 'message', function($scope, $location, baseURL, $rootScope, $routeParams, $timeout, $window, client, $route, $filter, getData, connection, loto, COMPANY_ID, local, message) {
      $scope.local = {};
      local.then(function(data) {
        $scope.local = data.local;
        $scope.dyna = data.dyna;
        return $scope.polyglot = data.polyglot;
      });
      $scope.noConnectionMessage = $scope.local.page_nointernet;
      $rootScope.updateEvents = function() {
        var getEvents;
        $scope.futureEvents = [];
        $scope.pastEvents = [];
        getEvents = function(data) {
          var now;
          $rootScope.events = data;
          now = (new Date()).getTime() / 1000;
          angular.forEach($rootScope.events, function(event) {
            if (event.end_date > now) {
              return $scope.futureEvents.push(event);
            } else {
              return $scope.pastEvents.push(event);
            }
          });
          $scope.pastEvents = $filter('orderBy')($scope.pastEvents, '+start_date');
          return $scope.futureEvents = $filter('orderBy')($scope.futureEvents, '+start_date');
        };
        return connection.makeLoad({
          params: {
            resource: 'event',
            data: {
              account_id: COMPANY_ID
            }
          },
          handler: getEvents,
          scope: $scope,
          type: "noCache"
        });
      };
      $scope.$on('$routeChangeSuccess', function() {
        var path;
        path = $location.$$path;
        if ($rootScope.event && path === baseURL.FEEDS) {
          $rootScope.event = null;
          $scope.participient = null;
        }
        if (!$rootScope.event && path !== baseURL.FEEDS && path !== baseURL.LOGIN) {
          $rootScope.backButton = true;
          connection.makeLoad({
            params: {
              resource: 'event',
              id: $routeParams.feedId
            },
            handler: function(data) {
              $rootScope.event = data;
              if ($rootScope.user) {
                return getData.noCache({
                  resource: 'participant',
                  data: {
                    event_id: $rootScope.event.id
                  }
                }, function(result) {
                  data = result.data;
                  return angular.forEach(data, function(participant) {
                    if (participant.event_id === $rootScope.event.id) {
                      $scope.participient = participant;
                      return $scope.dyna.tokens_val = $scope.polyglot.t("tokens_val", ~~participant.tokens);
                    }
                  });
                });
              }
            },
            scope: $scope,
            type: "noCache"
          });
        }
        if (path === baseURL.LOGIN) {
          $rootScope.forgot = true;
        } else {
          $rootScope.forgot = false;
        }
        if (path !== baseURL.FEEDS) {
          $scope.backButton = true;
        } else if ($scope.backButton) {
          $scope.backButton = false;
        }
        if (path === baseURL.PROFILE) {
          return $scope.edit = true;
        } else if ($scope.edit) {
          return $scope.edit = false;
        }
      });
      $scope.pastEventsCollapseder = function() {
        if ($scope.pastEventsCollapsed) {
          $scope.pastEventsCollapsed = false;
          return $scope.futureEventsCollapsed = true;
        } else {
          $scope.pastEventsCollapsed = true;
          return $scope.futureEventsCollapsed = true;
        }
      };
      $scope.futureEventsCollapseder = function() {
        if (!$scope.futureEventsCollapsed) {
          $scope.pastEventsCollapsed = false;
          return $scope.futureEventsCollapsed = true;
        } else {
          $scope.pastEventsCollapsed = false;
          return $scope.futureEventsCollapsed = false;
        }
      };
      $scope.leftMenuBlur = function($event) {
        $event.stopPropagation();
        return $scope.leftMenuActive = false;
      };
      $scope.leftMenuActivator = function($event) {
        if ($event.stopPropagation) {
          $event.stopPropagation();
        } else if ($location.$$path !== baseURL.FEEDS) {
          $location.path($event);
        }
        return $scope.leftMenuActive = !$scope.leftMenuActive;
      };
      $scope.leftMenuHide = function() {
        if ($scope.leftMenuActive) {
          return $scope.leftMenuActive = false;
        }
      };
      $scope.logoMainAnimateClass = {};
      $scope.logoMainAnimateClass[client.animationClass.logo] = $scope.logoSize;
      $scope.$watch('event', function(data) {
        return $scope.logoMainAnimateClass[client.animationClass.logo] = data;
      });
      $scope.animationContentLeft = client.animationClass.content.left;
      $scope.animationContentRight = client.animationClass.content.right;
      $scope.leftMenuAnimationType = client.animationClass.leftMenu;
      $scope.nextLocation = function(path) {
        if ($scope.contentAnimate !== $scope.animationContentLeft) {
          $scope.contentAnimate = $scope.animationContentLeft;
        }
        return $timeout(function() {
          return $location.path(path);
        }, 100);
      };
      $scope.backHistory = function() {
        if ($scope.contentAnimate !== $scope.animationContentRight) {
          $scope.contentAnimate = $scope.animationContentRight;
        }
        return $timeout(function() {
          return history.back();
        }, 100);
      };
      $scope.changeEvent = function(path, event) {
        $rootScope.event = event;
        if ($rootScope.user) {
          getData.noCache({
            resource: 'participant',
            data: {
              event_id: $rootScope.event.id
            }
          }, function(result) {
            var data;
            data = result.data;
            return angular.forEach(data, function(participant) {
              if (participant.event_id === $rootScope.event.id) {
                $scope.participient = participant;
                if ($scope.event.tokensActive && $scope.participient.is_first_visit === "1") {
                  message.open($scope.local.first_login);
                  return getData.put({
                    resource: 'participant'
                  }, {
                    data: {
                      id: $scope.participient.id,
                      extraParam: {
                        addTokens: 'firstLogin'
                      }
                    }
                  }, function(result) {
                    var tokens;
                    data = result.data;
                    tokens = data.message.receivedTokens;
                    return loto.run(tokens, function() {
                      return message.noClose($scope.polyglot.t("tokens_add", ~~tokens));
                    });
                  });
                }
              }
            });
          });
        }
        return $scope.nextLocation(path);
      };
      $scope.logOut = function() {
        client.user.logOut();
        $rootScope.user = null;
        $rootScope.participient = null;
        if ($location.$$path !== baseURL.FEEDS) {
          connection.makeLoad({
            params: {
              resource: 'event',
              id: $rootScope.event.id
            },
            handler: function(data) {
              if ($rootScope.user && $rootScope.event) {
                connection.makeLoad({
                  params: {
                    resource: 'participant',
                    data: {
                      data: {
                        event_id: $rootScope.event.id
                      }
                    }
                  },
                  handler: function(data) {
                    return angular.forEach(data, function(participant) {
                      return $rootScope.participient = participant;
                    });
                  },
                  scope: $scope,
                  type: "noCache"
                });
              }
              return $rootScope.event = data;
            },
            scope: $scope,
            type: "noCache"
          });
        }
        $rootScope.updateEvents();
        return $location.path(baseURL.FEEDS);
      };
      $scope.toDifferentUrl = function(url) {
        return $window.open(url, '_system');
      };
      document.addEventListener('backbutton', function() {
        if ($location.$$path !== baseURL.FEEDS) {
          if ($scope.contentAnimate !== $scope.animationContentRight) {
            $scope.contentAnimate = $scope.animationContentRight;
          }
          return $timeout(function() {
            return history.back();
          }, 100);
        } else {
          return navigator.app.exitApp();
        }
      });
      $rootScope.user = client.user.detail;
      $scope.share = "http%3A%2F%2Fwww%2Eatea%2Eno%2Fhovedmeny%2Fatea-community-2014%2F";
      return $scope.toComment = function() {
        return $location.path($routeParams.feedId + baseURL.COMMENTPAGEHREF);
      };
    }
  ]);

  atea.controller('LoginController', [
    '$scope', '$http', '$rootScope', '$location', 'baseURL', '$routeParams', '$timeout', 'client', 'connection', 'message', function($scope, $http, $rootScope, $location, baseURL, $routeParams, $timeout, client, connection, message) {
      $scope.go_submit = function() {
        if ($scope.auth.$dirty && $scope.auth.$valid) {
          message.open($scope.local.log_in);
          return client.user.login($scope.auth.username, $scope.auth.password).then(function(data) {
            $rootScope.user = data;
            return message.authoClose($scope.polyglot.t("login_message", {
              name: data.first_name
            }), function() {
              if ($rootScope.event) {
                connection.makeLoad({
                  params: {
                    resource: 'event',
                    id: $rootScope.event.id
                  },
                  handler: function(data) {
                    $rootScope.event = data;
                    return connection.makeLoad({
                      params: {
                        resource: 'participant',
                        data: {
                          data: {
                            event_id: $rootScope.event.id
                          }
                        }
                      },
                      handler: function(data) {
                        return angular.forEach(data, function(participant) {
                          return $rootScope.participient = participant;
                        });
                      },
                      scope: $scope,
                      type: "noCache"
                    });
                  },
                  scope: $scope,
                  type: "noCache"
                });
              }
              if ($scope.contentAnimate !== $scope.animationContentRight) {
                $scope.contentAnimate = $scope.animationContentRight;
              }
              return history.back();
            });
          }, function(error) {
            if (error.status === 401) {
              message.odinAndClose($scope.local.user_exist);
              return $rootScope.user = null;
            } else {
              return message.odinAndClose($scope.local.no_connection);
            }
          });
        } else {
          return message.odinAndClose($scope.local.incorrect_credentials);
        }
      };
      return $scope.pattern = /(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])/;
    }
  ]);

}).call(this);
