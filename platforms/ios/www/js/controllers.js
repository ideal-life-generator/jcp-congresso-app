// Generated by CoffeeScript 1.7.1
(function() {
  var atea;

  atea = angular.module('atea');

  atea.controller('RateController', [
    '$scope', '$location', 'baseURL', '$routeParams', 'connectionTest', '$filter', '$compile', 'message', 'getDataTest', '$http', 'loto', '$timeout', function($scope, $location, baseURL, $routeParams, connectionTest, $filter, $compile, message, getDataTest, $http, loto, $timeout) {
      $location.prevLocation = $routeParams.feedId + baseURL.RATESHREF;
      connectionTest.makeLoad({
        params: {
          resource: 'surveyQuestion',
          data: {
            survey_id: $routeParams.rateseId
          }
        },
        handler: function(data) {
          var tokes;
          $scope.fields = [];
          angular.forEach(data, function(field) {
            return $scope.fields.push(field);
          });
          $scope.fields = $filter('orderBy')($scope.fields, 'name');
          tokes = angular.element(document.querySelector("form[name='surveyForm'] ul"));
          return angular.forEach($scope.fields, function(field, i) {
            return tokes.append($compile("<survey-" + $scope.fields[i].type + " setting='fields[" + i + "]'></survey-" + $scope.fields[i].type + ">")($scope));
          });
        },
        scope: $scope,
        type: "get"
      });
      return $scope.submitSurveyQuestions = function() {
        var result;
        if ($scope.surveyForm.$valid) {
          message.wait("Please wait, processing data.");
          result = [];
          angular.forEach($scope.fields, function(field, i) {
            var proto;
            proto = {};
            if (field.value) {
              if (field.type === "checkboxlist") {
                return angular.forEach(field.options, function(option) {
                  if (option.value) {
                    proto = {};
                    proto.answer_value = option.answer_value;
                    proto.survey_id = $routeParams.rateseId;
                    proto.question_id = field.id;
                    return result.push(proto);
                  }
                });
              } else {
                proto.answer_value = field.value;
                proto.survey_id = $routeParams.rateseId;
                proto.question_id = field.id;
                return result.push(proto);
              }
            }
          });
          if (result.length && $scope.surveyForm.$valid) {
            return getDataTest.save({
              resource: 'surveyAnswer'
            }, {
              data: {
                records: result
              }
            }, function(result) {
              return message.success("Your form has been saved.", function() {
                if ($scope.event.tokensActive) {
                  return getDataTest.put({
                    resource: 'participant'
                  }, {
                    data: {
                      id: $scope.participient.id,
                      extraParam: {
                        addTokens: 'passageSurvey',
                        survey_id: $routeParams.rateseId
                      }
                    }
                  }, function(result) {
                    var data, string, tokens;
                    data = result.data;
                    tokens = data.message.receivedTokens.toString();
                    if (tokens.length < 3) {
                      string = "0" + tokens;
                    }
                    return loto.run(string, function() {
                      return $timeout(function() {
                        loto.number = null;
                        return message.success("You have received " + tokens + " tokens!", function() {
                          if ($scope.contentAnimate !== $scope.animationContentRight) {
                            $scope.contentAnimate = $scope.animationContentRight;
                          }
                          return history.back();
                        });
                      }, 1000);
                    });
                  });
                } else {
                  if ($scope.contentAnimate !== $scope.animationContentRight) {
                    $scope.contentAnimate = $scope.animationContentRight;
                  }
                  return history.back();
                }
              });
            }, function(error) {
              return message.warningAfter("No Internet connection.");
            });
          } else {
            return message.warningAfter("Form contains errors. Please fix them.");
          }
        } else {
          return message.warningAfter("Please fill in all the required fields in the form.");
        }
      };
    }
  ]);

  atea.controller('RatesController', [
    '$scope', '$location', 'baseURL', '$routeParams', 'connectionTest', 'message', '$rootScope', function($scope, $location, baseURL, $routeParams, connectionTest, message, $rootScope) {
      $location.prevLocation = baseURL.FEEDS + '/' + $routeParams.feedId;
      return connectionTest.makeLoad({
        params: {
          resource: 'survey',
          id: $routeParams.rateseId
        },
        handler: function(data) {
          if (!data.success) {
            $scope.surveys = [];
            return angular.forEach(data, function(survey) {
              if (survey.event_id === $rootScope.event.id) {
                return $scope.surveys.push(survey);
              }
            });
          } else {
            return message.warningAfter("No content.");
          }
        },
        scope: $scope,
        type: "get"
      });
    }
  ]);

  atea.controller('ProfileController', [
    '$scope', '$location', 'baseURL', '$routeParams', '$rootScope', 'connectionTest', function($scope, $location, baseURL, $routeParams, $rootScope, connectionTest) {
      return $location.prevLocation = baseURL.FEEDS;
    }
  ]);

  atea.controller('ScheduleController', [
    '$scope', '$location', 'baseURL', '$routeParams', 'getDataTest', '$http', 'message', '$rootScope', 'connection', 'connectionTest', function($scope, $location, baseURL, $routeParams, getDataTest, $http, message, $rootScope, connection, connectionTest) {
      $location.prevLocation = $routeParams.feedId + '/schedules';
      return connectionTest.makeLoad({
        params: {
          resource: 'activity',
          id: $routeParams.scheduleId
        },
        handler: function(data) {
          return $scope.schedule = data;
        },
        scope: $scope,
        type: "get"
      });
    }
  ]);

  atea.controller('SchedulesController', [
    '$scope', '$location', '$routeParams', 'getDataTest', '$filter', '$http', 'connection', '$rootScope', 'connectionTest', function($scope, $location, $routeParams, getDataTest, $filter, $http, connection, $rootScope, connectionTest) {
      var getSchedules;
      $location.prevLocation = 'feed/' + $routeParams.feedId;
      getSchedules = function(data) {
        var dayyy, oldData, ressuulltt, timeee;
        oldData = data;
        ressuulltt = [];
        data = [];
        dayyy = [];
        timeee = [];
        angular.forEach(oldData, function(ths) {
          return data.push(ths);
        });
        data = $filter('orderBy')(data, '+start_time');
        angular.forEach(data, function(ths, i, data) {
          var date, dateNext, day, dayNext, month, monthNext, n;
          date = new Date(ths.start_time * 1000);
          day = date.getDate();
          month = date.getMonth();
          if (data[i + 1]) {
            n = 1;
          } else {
            n = -1;
          }
          dateNext = new Date(data[i + n].start_time * 1000);
          dayNext = dateNext.getDate();
          monthNext = dateNext.getMonth();
          if (ths.start_time === data[i + n].start_time) {
            timeee.push(ths);
          } else {
            timeee.push(ths);
            dayyy.push(timeee);
            timeee = [];
          }
          if (!(day === dayNext && month === monthNext)) {
            ressuulltt.push(dayyy);
            return dayyy = [];
          }
        });
        return $scope.schedules = ressuulltt;
      };
      return connectionTest.makeLoad({
        params: {
          resource: "activity",
          data: "{'event_id': " + $routeParams.feedId + "}"
        },
        handler: getSchedules,
        scope: $scope,
        type: "get"
      });
    }
  ]);

  atea.controller('CommentController', [
    '$scope', '$location', 'baseURL', '$routeParams', '$rootScope', '$http', '$timeout', 'message', 'connectionTest', function($scope, $location, baseURL, $routeParams, $rootScope, $http, $timeout, message, connectionTest) {
      $location.prevLocation = baseURL.FEEDS + "/" + $routeParams.feedId;
      $scope.categories = [
        {
          id: null,
          name: "Select a category"
        }
      ];
      connectionTest.makeLoad({
        params: {
          resource: 'leadType'
        },
        handler: function(data) {
          return angular.forEach(data, function(ths) {
            return $scope.categories.push(ths);
          });
        },
        scope: $scope,
        type: "get"
      });
      $scope.categorieActive = "Select a category";
      $scope.interest = "5";
      $scope.revenue = "5";
      return $scope.submit = function() {
        var data;
        if ($scope.categorieActive !== $scope.categories[0].name) {
          $scope.noValid = false;
          data = {
            interrogatorId: userStatus.detail.eventId,
            categorie: $scope.categorieActive,
            interest: $scope.interest,
            revenue: $scope.revenue,
            comment: $scope.comments
          };
          message.wait = "Sending data.";
          return getData.submitRecord(data).$promise.then(function() {
            return message.success("Your message has been posted.", function() {
              return $location.path($location.prevLocation);
            });
          });
        } else {
          return $scope.noValid = true;
        }
      };
    }
  ]);

  atea.controller('PartnerController', [
    '$scope', '$location', 'baseURL', '$routeParams', '$rootScope', 'message', 'connectionTest', 'getDataTest', '$http', function($scope, $location, baseURL, $routeParams, $rootScope, message, connectionTest, getDataTest, $http) {
      $location.prevLocation = $routeParams.feedId + '/partners';
      connectionTest.makeLoad({
        params: {
          resource: 'partnerCompany',
          id: $routeParams.partnerId
        },
        handler: function(data) {
          return $scope.partner = data;
        },
        scope: $scope,
        type: "get"
      });
      return $scope.submitQuestion = function() {
        if ($scope.questionToPartner) {
          message.wait("Please wait, processing data.");
          return getDataTest.save({
            resource: 'partnerMessage'
          }, {
            data: {
              event_id: $routeParams.feedId,
              message: $scope.questionToPartner
            }
          }, function(result) {
            message.success("Your question has been sent.");
            return $scope.invalid = false;
          }, function(error) {
            return message.warningAfter("No Internet connection.");
          });
        } else if ($scope.form.$dirty) {
          return message.warningAfter("Question should be at least 16 characters long.");
        } else {
          message.warningAfter("Please fill in the input.");
          return $scope.invalid = true;
        }
      };
    }
  ]);

  atea.controller('PartnersController', [
    '$scope', '$location', 'baseURL', '$routeParams', '$rootScope', '$http', '$filter', 'getDataTest', 'connection', 'connectionTest', function($scope, $location, baseURL, $routeParams, $rootScope, $http, $filter, getDataTest, connection, connectionTest) {
      var getPartners;
      $location.prevLocation = 'feed/' + $routeParams.feedId;
      getPartners = function(data) {
        $scope.partners = [];
        return angular.forEach(data, function(partner) {
          return $scope.partners.push(partner);
        });
      };
      return connectionTest.makeLoad({
        params: {
          resource: 'partnerCompany',
          data: "{'event_id': " + $routeParams.feedId + "}"
        },
        handler: getPartners,
        scope: $scope,
        type: "get"
      });
    }
  ]);

  atea.controller('GuestController', [
    '$scope', '$window', '$location', 'baseURL', '$routeParams', '$rootScope', 'client', 'connection', 'getDataTest', 'connectionTest', 'message', function($scope, $window, $location, baseURL, $routeParams, $rootScope, client, connection, getDataTest, connectionTest, message) {
      $location.prevLocation = baseURL.FEEDS;
      return $scope.scanActivator = function() {
        return cordova.plugins.barcodeScanner.scan(function(result) {
          return connectionTest.makeLoad({
            params: {
              resource: 'member',
              data: "{ 'extraParam': { 'barcode': '" + result.text + "' }}"
            },
            handler: function(data) {
              if (data.success) {
                return message.warning("No user");
              } else {
                $rootScope.member = data;
                $location.path("/" + $routeParams.feedId + '/scan/comment');
                return $scope.$apply();
              }
            },
            scope: $scope,
            type: "noCache"
          });
        }, function(error) {
          return message.warning("Error scaning");
        });
      };
    }
  ]);

  atea.controller('EventsController', [
    '$scope', '$filter', 'baseURL', '$location', '$rootScope', '$routeParams', 'connectionTest', 'client', function($scope, $filter, baseURL, $location, $rootScope, $routeParams, connectionTest, client) {
      $rootScope.event = null;
      return $rootScope.updateEvents();
    }
  ]);

  atea.controller('MainController', [
    '$scope', '$location', 'baseURL', '$rootScope', '$routeParams', '$timeout', 'message', '$window', 'client', '$route', '$filter', 'getDataTest', 'connectionTest', 'loto', function($scope, $location, baseURL, $rootScope, $routeParams, $timeout, message, $window, client, $route, $filter, getDataTest, connectionTest, loto) {
      $scope.noConnectionMessage = "No internet connection is available at the moment. Please, click this message to try to connect again.";
      $rootScope.updateEvents = function() {
        var getEvents;
        $scope.futureEvents = [];
        $scope.pastEvents = [];
        getEvents = function(data) {
          var now;
          $rootScope.events = data;
          now = (new Date()).getTime() / 1000;
          angular.forEach($rootScope.events, function(event) {
            if (event.end_date > now) {
              return $scope.futureEvents.push(event);
            } else {
              return $scope.pastEvents.push(event);
            }
          });
          $scope.pastEvents = $filter('orderBy')($scope.pastEvents, '+start_date');
          return $scope.futureEvents = $filter('orderBy')($scope.futureEvents, '+start_date');
        };
        return connectionTest.makeLoad({
          params: {
            resource: 'event'
          },
          handler: getEvents,
          scope: $scope,
          type: "noCache"
        });
      };
      $scope.$on('$routeChangeSuccess', function() {
        var path;
        path = $location.$$path;
        if ($rootScope.event && path === baseURL.FEEDS) {
          $rootScope.event = null;
          $scope.participient = null;
        }
        if (!$rootScope.event && path !== baseURL.FEEDS && path !== baseURL.LOGIN) {
          $rootScope.backButton = true;
          connectionTest.makeLoad({
            params: {
              resource: 'event',
              id: $routeParams.feedId
            },
            handler: function(data) {
              $rootScope.event = data;
              if ($rootScope.user) {
                return connectionTest.makeLoad({
                  params: {
                    resource: 'participant',
                    data: {
                      event_id: $rootScope.event.id
                    }
                  },
                  handler: function(data) {
                    return angular.forEach(data, function(participant) {
                      if (participant.event_id === $rootScope.event.id) {
                        return $scope.participient = participant;
                      }
                    });
                  },
                  scope: $scope,
                  type: "noCache"
                });
              }
            },
            scope: $scope,
            type: "noCache"
          });
        }
        if (path === baseURL.LOGIN) {
          $rootScope.backButton = true;
          $rootScope.forgot = true;
        } else {
          $rootScope.forgot = false;
        }
        if (path === baseURL.FEEDS) {
          return $rootScope.backButton = false;
        }
      });
      $scope.pastEventsCollapseder = function() {
        if ($scope.pastEventsCollapsed) {
          $scope.pastEventsCollapsed = false;
          return $scope.futureEventsCollapsed = true;
        } else {
          $scope.pastEventsCollapsed = true;
          return $scope.futureEventsCollapsed = true;
        }
      };
      $scope.futureEventsCollapseder = function() {
        if (!$scope.futureEventsCollapsed) {
          $scope.pastEventsCollapsed = false;
          return $scope.futureEventsCollapsed = true;
        } else {
          $scope.pastEventsCollapsed = false;
          return $scope.futureEventsCollapsed = false;
        }
      };
      $scope.leftMenuBlur = function($event) {
        $event.stopPropagation();
        return $scope.leftMenuActive = false;
      };
      $scope.leftMenuActivator = function($event) {
        if ($event.stopPropagation) {
          $event.stopPropagation();
        } else if ($location.$$path !== baseURL.FEEDS) {
          $location.path($event);
        }
        return $scope.leftMenuActive = !$scope.leftMenuActive;
      };
      $scope.leftMenuHide = function() {
        if ($scope.leftMenuActive) {
          return $scope.leftMenuActive = false;
        }
      };
      $scope.logoMainAnimateClass = {};
      $scope.logoMainAnimateClass[client.animationClass.logo] = $scope.logoSize;
      $scope.$watch('event', function(data) {
        return $scope.logoMainAnimateClass[client.animationClass.logo] = data;
      });
      $scope.animationContentLeft = client.animationClass.content.left;
      $scope.animationContentRight = client.animationClass.content.right;
      $scope.leftMenuAnimationType = client.animationClass.leftMenu;
      $scope.backLocation = function(path) {
        if ($scope.contentAnimate !== $scope.animationContentRight) {
          $scope.contentAnimate = $scope.animationContentRight;
        }
        if ($location.prevLocation === '/feed') {
          $scope.logoSize = false;
        }
        if (path) {
          return $timeout(function() {
            return $location.path(path);
          }, 100);
        } else {
          return $timeout(function() {
            return $location.path($location.prevLocation);
          }, 100);
        }
      };
      $scope.nextLocation = function(path) {
        if ($scope.contentAnimate !== $scope.animationContentLeft) {
          $scope.contentAnimate = $scope.animationContentLeft;
        }
        $scope.logoSize = true;
        return $timeout(function() {
          return $location.path(path);
        }, 100);
      };
      $scope.changeEvent = function(path, event) {
        $rootScope.event = event;
        if ($rootScope.user) {
          connectionTest.makeLoad({
            params: {
              resource: 'participant',
              data: {
                event_id: $rootScope.event.id
              }
            },
            handler: function(data) {
              return angular.forEach(data, function(participant) {
                if (participant.event_id === $rootScope.event.id) {
                  $scope.participient = participant;
                  if ($scope.event.tokensActive && $scope.participient.is_first_visit === "1") {
                    return message.success("This is the first time you've logged in to this event. You are about to receive tokens!", function() {
                      return getDataTest.put({
                        resource: 'participant'
                      }, {
                        data: {
                          id: $scope.participient.id,
                          extraParam: {
                            addTokens: 'firstLogin'
                          }
                        }
                      }, function(result) {
                        var string, tokens;
                        data = result.data;
                        tokens = data.message.receivedTokens.toString();
                        if (tokens.length === 2) {
                          string = "0" + tokens;
                        }
                        return loto.run(string, function() {
                          return $timeout(function() {
                            loto.number = null;
                            return message.success("You have received " + tokens + " tokens!", function() {});
                          }, 1000);
                        });
                      });
                    });
                  }
                }
              });
            },
            scope: $scope,
            type: "noCache"
          });
        }
        return $scope.nextLocation(path);
      };
      $scope.logOut = function() {
        client.user.logOut();
        $rootScope.user = null;
        $rootScope.participient = null;
        if ($location.$$path !== baseURL.FEEDS) {
          connectionTest.makeLoad({
            params: {
              resource: 'event',
              id: $rootScope.event.id
            },
            handler: function(data) {
              if ($rootScope.user && $rootScope.event) {
                connectionTest.makeLoad({
                  params: {
                    resource: 'participant',
                    data: {
                      data: {
                        event_id: $rootScope.event.id
                      }
                    }
                  },
                  handler: function(data) {
                    return angular.forEach(data, function(participant) {
                      return $rootScope.participient = participant;
                    });
                  },
                  scope: $scope,
                  type: "noCache"
                });
              }
              return $rootScope.event = data;
            },
            scope: $scope,
            type: "noCache"
          });
        }
        return $rootScope.updateEvents();
      };
      $scope.toDifferentUrl = function(url) {
        return $window.open(url, '_system');
      };
      document.addEventListener('deviceready', function() {
        return document.addEventListener('backbutton', function() {
          if ($location.$$path !== '/feed') {
            if ($scope.contentAnimate !== $scope.animationContentRight) {
              $scope.contentAnimate = $scope.animationContentRight;
            }
            return $timeout(function() {
              return $location.path($location.prevLocation);
            }, 100);
          } else {
            return navigator.app.exitApp();
          }
        });
      });
      $rootScope.user = client.user.detail;
      return $scope.backHistory = function() {
        if ($scope.contentAnimate !== $scope.animationContentRight) {
          $scope.contentAnimate = $scope.animationContentRight;
        }
        return history.back();
      };
    }
  ]);

  atea.controller('LoginController', [
    '$scope', '$http', '$rootScope', '$location', 'baseURL', '$routeParams', '$timeout', 'message', 'client', 'connectionTest', function($scope, $http, $rootScope, $location, baseURL, $routeParams, $timeout, message, client, connectionTest) {
      $location.prevLocation = baseURL.FEEDS;
      $scope.login = {};
      $scope.login.submit = function() {
        if ($scope.authorization.$dirty && $scope.authorization.$valid) {
          message.wait("Please wait, logging in.");
          return client.user.login($scope.login.username, $scope.login.password).then(function(data) {
            $rootScope.user = data;
            message.success("Welcome " + data.first_name + "!", function() {});
            if ($rootScope.event) {
              connectionTest.makeLoad({
                params: {
                  resource: 'event',
                  id: $rootScope.event.id
                },
                handler: function(data) {
                  $rootScope.event = data;
                  return connectionTest.makeLoad({
                    params: {
                      resource: 'participant',
                      data: {
                        data: {
                          event_id: $rootScope.event.id
                        }
                      }
                    },
                    handler: function(data) {
                      return angular.forEach(data, function(participant) {
                        return $rootScope.participient = participant;
                      });
                    },
                    scope: $scope,
                    type: "noCache"
                  });
                },
                scope: $scope,
                type: "noCache"
              });
            }
            if ($scope.contentAnimate !== $scope.animationContentRight) {
              $scope.contentAnimate = $scope.animationContentRight;
            }
            return history.back();
          }, function(error) {
            if (error.status === 401) {
              message.warningAfter("User doesn't exist.");
              return $rootScope.user = null;
            } else {
              return message.warning("No internet connection.");
            }
          });
        } else {
          return message.warning("Incorrect credentials.");
        }
      };
      return $scope.pattern = /(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])/;
    }
  ]);

}).call(this);
